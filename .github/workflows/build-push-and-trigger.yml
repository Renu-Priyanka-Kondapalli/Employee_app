name: Build & Deploy App via GHCR

on:
  push:
    branches: [ master ]

jobs:

  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # ------------------------------
      # Backend Build
      # ------------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Build Backend
        run: mvn -B -DskipTests=true clean package
        working-directory: backend

      # ------------------------------
      # Frontend Build
      # ------------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install
        working-directory: frontend

      - name: Fix Angular CLI permissions
        run: chmod +x ./node_modules/.bin/ng
        working-directory: frontend

      - name: Build frontend (Production)
        run: npm run build -- --configuration production
        working-directory: frontend

      # ------------------------------
      # Login to GHCR
      # ------------------------------
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_PAT }}

      # ------------------------------
      # Lowercase Repo Owner for GHCR
      # ------------------------------
      - name: Set lowercase repo owner
        run: echo "REPO_OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      # ------------------------------
      # Docker Builds
      # ------------------------------
      - name: Build Backend Image
        run: |
          docker build -t ghcr.io/${REPO_OWNER_LC}/employee-backend:${{ github.run_number }} backend

      - name: Build Frontend Image
        run: |
          docker build -t ghcr.io/${REPO_OWNER_LC}/employee-frontend:${{ github.run_number }} frontend

      # ------------------------------
      # Push to GHCR
      # ------------------------------
      - name: Push Images to GHCR
        run: |
          docker push ghcr.io/${REPO_OWNER_LC}/employee-backend:${{ github.run_number }}
          docker push ghcr.io/${REPO_OWNER_LC}/employee-frontend:${{ github.run_number }}
